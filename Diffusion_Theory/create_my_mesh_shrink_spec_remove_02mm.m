gis_args.medfilter=1;
[mask param] = GetImageStack('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vesselremoved_shrink_spe_mimicCC_0.2_flip.mha',gis_args);

param.facet_angle = (25.0);
param.facet_distance = (0.5);
param.facet_size = (0.5);

param.medfilter = 0;
param.pad = 0;
param.cell_size = (0.5);
param.cell_radius_edge = (1);
param.special_subdomain_label = (0);
param.special_subdomain_size  = (0);

sx=(0.2);
sy=(0.2);
sz=(0.2);

param.PixelDimensions(1) = sx;
param.PixelDimensions(2) = sy;
param.PixelDimensions(3) = sz;
param.PixelSpacing(1) = sx;
param.PixelSpacing(2) = sy;
param.SliceThickness  = sz;

outfn = '/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vesselremoved_shrink_spe_mimicCC_0.2_flip.ele';
param.tmppath = fileparts(outfn);
if isempty(param.tmppath), param.tmppath = getuserdir(); end
param.delmedit = 0;

[e p] = RunCGALMeshGenerator(mask,param);
if size(e,2) > 4, mat = e(:,5); else, mat = ones(size(e,1),1); end

q1 = simpqual(p, e, 'Min_Sin_Dihedral');
genmesh.ele = e;
genmesh.node = p;
genmesh.ele(:,5) = mat; genmesh.nnpe = 4; genmesh.dim = 3;
solidmesh2nirfast(genmesh,'/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vesselremoved_shrink_spe_mimicCC_0.2_flip_nirfast_mesh','spec');
fprintf('done.\n');

mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vesselremoved_shrink_spe_mimicCC_0.2_flip_nirfast_mesh');
clear e f1 f2 genmesh info mask mat e p sx sy sz cr1 cr2 genmesh outfn param
clear save_fn
%--------------------%

mesh_tmp = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vesselremoved_shrink_spe_mimicCC_0.2_flip_nirfast_mesh');
mesh_tmp.link =[ 1 1 1; 2 1 1; 3 1 1; 4 1 1; 5 1 1; 6 1 1; 7 1 1; 8 1 1; 9 1 1; 10 1 1; 11 1 1; 12 1 1; 13 1 1; 14 1 1; 15 1 1; 16 1 1; 17 1 1; 18 1 1; 19 1 1; 20 1 1; 21 1 1; 22 1 1; 23 1 1; 24 1 1; 25 1 1; 26 1 1; 27 1 1; 28 1 1; 29 1 1; 30 1 1; 31 1 1; 32 1 1; 33 1 1; 34 1 1; 35 1 1; 36 1 1; 37 1 1; 38 1 1; 39 1 1; 40 1 1; 41 1 1; 42 1 1; 43 1 1; 44 1 1; 45 1 1; 46 1 1; 47 1 1; 48 1 1; 49 1 1; 50 1 1; 51 1 1; 52 1 1; 53 1 1; 54 1 1; 55 1 1; 56 1 1; 57 1 1; 58 1 1; 59 1 1; 60 1 1; 61 1 1; 62 1 1; 63 1 1; 64 1 1; 65 1 1; 66 1 1; 67 1 1; 68 1 1; 69 1 1; 70 1 1; 71 1 1; 72 1 1; 73 1 1; 74 1 1; 75 1 1; 76 1 1; 77 1 1; 78 1 1; 79 1 1; 80 1 1; 81 1 1; 82 1 1; 83 1 1; 84 1 1; 85 1 1; 86 1 1; 87 1 1; 88 1 1; 89 1 1; 90 1 1; 91 1 1; 92 1 1; 93 1 1; 94 1 1; 95 1 1; 96 1 1; 97 1 1; 98 1 1; 99 1 1; 100 1 1;];
mesh_tmp.source.coord =[5 2 13;5 2.26262626262626 13;5 2.52525252525253 13;5 2.78787878787879 13;5 3.05050505050505 13;5 3.31313131313131 13;5 3.57575757575758 13;5 3.83838383838384 13;5 4.1010101010101 13;5 4.36363636363636 13;5 4.62626262626263 13;5 4.88888888888889 13;5 5.15151515151515 13;5 5.41414141414142 13;5 5.67676767676768 13;5 5.93939393939394 13;5 6.2020202020202 13;5 6.46464646464647 13;5 6.72727272727273 13;5 6.98989898989899 13;5 7.25252525252526 13;5 7.51515151515152 13;5 7.77777777777778 13;5 8.04040404040405 13;5 8.30303030303031 13;5 8.56565656565657 13;5 8.82828282828283 13;5 9.0909090909091 13;5 9.35353535353536 13;5 9.61616161616162 13;5 9.87878787878789 13;5 10.1414141414141 13;5 10.4040404040404 13;5 10.6666666666667 13;5 10.9292929292929 13;5 11.1919191919192 13;5 11.4545454545455 13;5 11.7171717171717 13;5 11.979797979798 13;5 12.2424242424243 13;5 12.5050505050505 13;5 12.7676767676768 13;5 13.030303030303 13;5 13.2929292929293 13;5 13.5555555555556 13;5 13.8181818181818 13;5 14.0808080808081 13;5 14.3434343434344 13;5 14.6060606060606 13;5 14.8686868686869 13;5 15.1313131313131 13;5 15.3939393939394 13;5 15.6565656565657 13;5 15.9191919191919 13;5 16.1818181818182 13;5 16.4444444444445 13;5 16.7070707070707 13;5 16.969696969697 13;5 17.2323232323232 13;5 17.4949494949495 13;5 17.7575757575758 13;5 18.020202020202 13;5 18.2828282828283 13;5 18.5454545454546 13;5 18.8080808080808 13;5 19.0707070707071 13;5 19.3333333333334 13;5 19.5959595959596 13;5 19.8585858585859 13;5 20.1212121212121 13;5 20.3838383838384 13;5 20.6464646464647 13;5 20.9090909090909 13;5 21.1717171717172 13;5 21.4343434343435 13;5 21.6969696969697 13;5 21.959595959596 13;5 22.2222222222222 13;5 22.4848484848485 13;5 22.7474747474748 13;5 23.010101010101 13;5 23.2727272727273 13;5 23.5353535353536 13;5 23.7979797979798 13;5 24.0606060606061 13;5 24.3232323232324 13;5 24.5858585858586 13;5 24.8484848484849 13;5 25.1111111111111 13;5 25.3737373737374 13;5 25.6363636363637 13;5 25.8989898989899 13;5 26.1616161616162 13;5 26.4242424242425 13;5 26.6868686868687 13;5 26.949494949495 13;5 27.2121212121212 13;5 27.4747474747475 13;5 27.7373737373738 13;5 28 13];
mesh_tmp.source.num = (1:size([5 2 13;5 2.26262626262626 13;5 2.52525252525253 13;5 2.78787878787879 13;5 3.05050505050505 13;5 3.31313131313131 13;5 3.57575757575758 13;5 3.83838383838384 13;5 4.1010101010101 13;5 4.36363636363636 13;5 4.62626262626263 13;5 4.88888888888889 13;5 5.15151515151515 13;5 5.41414141414142 13;5 5.67676767676768 13;5 5.93939393939394 13;5 6.2020202020202 13;5 6.46464646464647 13;5 6.72727272727273 13;5 6.98989898989899 13;5 7.25252525252526 13;5 7.51515151515152 13;5 7.77777777777778 13;5 8.04040404040405 13;5 8.30303030303031 13;5 8.56565656565657 13;5 8.82828282828283 13;5 9.0909090909091 13;5 9.35353535353536 13;5 9.61616161616162 13;5 9.87878787878789 13;5 10.1414141414141 13;5 10.4040404040404 13;5 10.6666666666667 13;5 10.9292929292929 13;5 11.1919191919192 13;5 11.4545454545455 13;5 11.7171717171717 13;5 11.979797979798 13;5 12.2424242424243 13;5 12.5050505050505 13;5 12.7676767676768 13;5 13.030303030303 13;5 13.2929292929293 13;5 13.5555555555556 13;5 13.8181818181818 13;5 14.0808080808081 13;5 14.3434343434344 13;5 14.6060606060606 13;5 14.8686868686869 13;5 15.1313131313131 13;5 15.3939393939394 13;5 15.6565656565657 13;5 15.9191919191919 13;5 16.1818181818182 13;5 16.4444444444445 13;5 16.7070707070707 13;5 16.969696969697 13;5 17.2323232323232 13;5 17.4949494949495 13;5 17.7575757575758 13;5 18.020202020202 13;5 18.2828282828283 13;5 18.5454545454546 13;5 18.8080808080808 13;5 19.0707070707071 13;5 19.3333333333334 13;5 19.5959595959596 13;5 19.8585858585859 13;5 20.1212121212121 13;5 20.3838383838384 13;5 20.6464646464647 13;5 20.9090909090909 13;5 21.1717171717172 13;5 21.4343434343435 13;5 21.6969696969697 13;5 21.959595959596 13;5 22.2222222222222 13;5 22.4848484848485 13;5 22.7474747474748 13;5 23.010101010101 13;5 23.2727272727273 13;5 23.5353535353536 13;5 23.7979797979798 13;5 24.0606060606061 13;5 24.3232323232324 13;5 24.5858585858586 13;5 24.8484848484849 13;5 25.1111111111111 13;5 25.3737373737374 13;5 25.6363636363637 13;5 25.8989898989899 13;5 26.1616161616162 13;5 26.4242424242425 13;5 26.6868686868687 13;5 26.949494949495 13;5 27.2121212121212 13;5 27.4747474747475 13;5 27.7373737373738 13;5 28 13],1))';
mesh_tmp.source.fwhm = zeros(size([5 2 13;5 2.26262626262626 13;5 2.52525252525253 13;5 2.78787878787879 13;5 3.05050505050505 13;5 3.31313131313131 13;5 3.57575757575758 13;5 3.83838383838384 13;5 4.1010101010101 13;5 4.36363636363636 13;5 4.62626262626263 13;5 4.88888888888889 13;5 5.15151515151515 13;5 5.41414141414142 13;5 5.67676767676768 13;5 5.93939393939394 13;5 6.2020202020202 13;5 6.46464646464647 13;5 6.72727272727273 13;5 6.98989898989899 13;5 7.25252525252526 13;5 7.51515151515152 13;5 7.77777777777778 13;5 8.04040404040405 13;5 8.30303030303031 13;5 8.56565656565657 13;5 8.82828282828283 13;5 9.0909090909091 13;5 9.35353535353536 13;5 9.61616161616162 13;5 9.87878787878789 13;5 10.1414141414141 13;5 10.4040404040404 13;5 10.6666666666667 13;5 10.9292929292929 13;5 11.1919191919192 13;5 11.4545454545455 13;5 11.7171717171717 13;5 11.979797979798 13;5 12.2424242424243 13;5 12.5050505050505 13;5 12.7676767676768 13;5 13.030303030303 13;5 13.2929292929293 13;5 13.5555555555556 13;5 13.8181818181818 13;5 14.0808080808081 13;5 14.3434343434344 13;5 14.6060606060606 13;5 14.8686868686869 13;5 15.1313131313131 13;5 15.3939393939394 13;5 15.6565656565657 13;5 15.9191919191919 13;5 16.1818181818182 13;5 16.4444444444445 13;5 16.7070707070707 13;5 16.969696969697 13;5 17.2323232323232 13;5 17.4949494949495 13;5 17.7575757575758 13;5 18.020202020202 13;5 18.2828282828283 13;5 18.5454545454546 13;5 18.8080808080808 13;5 19.0707070707071 13;5 19.3333333333334 13;5 19.5959595959596 13;5 19.8585858585859 13;5 20.1212121212121 13;5 20.3838383838384 13;5 20.6464646464647 13;5 20.9090909090909 13;5 21.1717171717172 13;5 21.4343434343435 13;5 21.6969696969697 13;5 21.959595959596 13;5 22.2222222222222 13;5 22.4848484848485 13;5 22.7474747474748 13;5 23.010101010101 13;5 23.2727272727273 13;5 23.5353535353536 13;5 23.7979797979798 13;5 24.0606060606061 13;5 24.3232323232324 13;5 24.5858585858586 13;5 24.8484848484849 13;5 25.1111111111111 13;5 25.3737373737374 13;5 25.6363636363637 13;5 25.8989898989899 13;5 26.1616161616162 13;5 26.4242424242425 13;5 26.6868686868687 13;5 26.949494949495 13;5 27.2121212121212 13;5 27.4747474747475 13;5 27.7373737373738 13;5 28 13],1),1);
mesh_tmp.source.fixed =0;
mesh_tmp.source.distributed =1;
mesh_tmp.meas.coord =[5 15 6];
mesh_tmp.meas.num = (1:size([5 15 6],1))';
mesh_tmp.meas.fixed =0;
mesh_tmp = minband_opt(mesh_tmp);
save_mesh(mesh_tmp,'/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vesselremoved_shrink_spe_mimicCC_0.2_flip_nirfast_mesh');
clear mesh_tmp
mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vesselremoved_shrink_spe_mimicCC_0.2_flip_nirfast_mesh');
set_chromophores('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vesselremoved_shrink_spe_mimicCC_0.2_flip_nirfast_mesh',{'HbO';'deoxyHb';'Water';},[700 710 720 730 740 750 760 770 780 790 800 810 820 830 840 850 860 870 880 890 900]);
mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vesselremoved_shrink_spe_mimicCC_0.2_flip_nirfast_mesh');
