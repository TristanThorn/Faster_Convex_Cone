gis_args.medfilter=1;
[mask param] = GetImageStack('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_new_mimicCC_0.05_flip.mha',gis_args);

param.facet_angle = (1);
param.facet_distance = (0.2);
param.facet_size = (0.2);

param.medfilter = 0;
param.pad = 0;
param.cell_size = (0.2);
param.cell_radius_edge = (3.0);
param.special_subdomain_label = (0);
param.special_subdomain_size  = (0);

sx=(0.05);
sy=(0.05);
sz=(0.05);

param.PixelDimensions(1) = sx;
param.PixelDimensions(2) = sy;
param.PixelDimensions(3) = sz;
param.PixelSpacing(1) = sx;
param.PixelSpacing(2) = sy;
param.SliceThickness  = sz;

outfn = '/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_new_mimicCC_0.05_flip.ele';
param.tmppath = fileparts(outfn);
if isempty(param.tmppath), param.tmppath = getuserdir(); end
param.delmedit = 0;

[e p] = RunCGALMeshGenerator(mask,param);
if size(e,2) > 4, mat = e(:,5); else, mat = ones(size(e,1),1); end

q1 = simpqual(p, e, 'Min_Sin_Dihedral');
genmesh.ele = e;
genmesh.node = p;
genmesh.ele(:,5) = mat; genmesh.nnpe = 4; genmesh.dim = 3;
solidmesh2nirfast(genmesh,'/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_new_mimicCC_0.05_flip_nirfast_mesh','spec');
fprintf('done.\n');

mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_new_mimicCC_0.05_flip_nirfast_mesh');
clear e f1 f2 genmesh info mask mat e p sx sy sz cr1 cr2 genmesh outfn param
clear save_fn
%--------------------%

mesh_tmp = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_new_mimicCC_0.05_flip_nirfast_mesh');
mesh_tmp.link =[ 1 1 1; 2 1 1; 3 1 1; 4 1 1; 5 1 1; 6 1 1; 7 1 1; 8 1 1; 9 1 1; 10 1 1; 11 1 1; 12 1 1; 13 1 1; 14 1 1; 15 1 1; 16 1 1; 17 1 1; 18 1 1; 19 1 1; 20 1 1; 21 1 1; 22 1 1; 23 1 1; 24 1 1; 25 1 1; 26 1 1; 27 1 1; 28 1 1; 29 1 1; 30 1 1; 31 1 1; 32 1 1; 33 1 1; 34 1 1; 35 1 1; 36 1 1; 37 1 1; 38 1 1; 39 1 1; 40 1 1; 41 1 1; 42 1 1; 43 1 1; 44 1 1; 45 1 1; 46 1 1; 47 1 1; 48 1 1; 49 1 1; 50 1 1; 51 1 1; 52 1 1; 53 1 1; 54 1 1; 55 1 1; 56 1 1; 57 1 1; 58 1 1; 59 1 1; 60 1 1; 61 1 1; 62 1 1; 63 1 1; 64 1 1; 65 1 1; 66 1 1; 67 1 1; 68 1 1; 69 1 1; 70 1 1; 71 1 1; 72 1 1; 73 1 1; 74 1 1; 75 1 1; 76 1 1; 77 1 1; 78 1 1; 79 1 1; 80 1 1; 81 1 1; 82 1 1; 83 1 1; 84 1 1; 85 1 1; 86 1 1; 87 1 1; 88 1 1; 89 1 1; 90 1 1; 91 1 1; 92 1 1; 93 1 1; 94 1 1; 95 1 1; 96 1 1; 97 1 1; 98 1 1; 99 1 1; 100 1 1; 101 1 1; 102 1 1; 103 1 1; 104 1 1; 105 1 1; 106 1 1; 107 1 1; 108 1 1; 109 1 1; 110 1 1; 111 1 1; 112 1 1; 113 1 1; 114 1 1; 115 1 1; 116 1 1; 117 1 1; 118 1 1; 119 1 1; 120 1 1; 121 1 1; 122 1 1; 123 1 1; 124 1 1; 125 1 1; 126 1 1; 127 1 1; 128 1 1; 129 1 1; 130 1 1; 131 1 1; 132 1 1; 133 1 1; 134 1 1; 135 1 1; 136 1 1; 137 1 1; 138 1 1; 139 1 1; 140 1 1; 141 1 1; 142 1 1; 143 1 1; 144 1 1; 145 1 1; 146 1 1; 147 1 1; 148 1 1; 149 1 1; 150 1 1; 151 1 1; 152 1 1; 153 1 1; 154 1 1; 155 1 1; 156 1 1; 157 1 1; 158 1 1; 159 1 1; 160 1 1; 161 1 1; 162 1 1; 163 1 1; 164 1 1; 165 1 1; 166 1 1; 167 1 1; 168 1 1; 169 1 1; 170 1 1; 171 1 1; 172 1 1; 173 1 1; 174 1 1; 175 1 1; 176 1 1; 177 1 1; 178 1 1; 179 1 1; 180 1 1; 181 1 1; 182 1 1; 183 1 1; 184 1 1; 185 1 1; 186 1 1; 187 1 1; 188 1 1; 189 1 1; 190 1 1; 191 1 1; 192 1 1; 193 1 1; 194 1 1; 195 1 1; 196 1 1; 197 1 1; 198 1 1; 199 1 1; 200 1 1;];
mesh_tmp.source.coord =[9 2 21;9 2.13065326633166 21;9 2.26130653266332 21;9 2.39195979899497 21;9 2.52261306532663 21;9 2.65326633165829 21;9 2.78391959798995 21;9 2.91457286432161 21;9 3.04522613065327 21;9 3.17587939698492 21;9 3.30653266331658 21;9 3.43718592964824 21;9 3.5678391959799 21;9 3.69849246231156 21;9 3.82914572864321 21;9 3.95979899497487 21;9 4.09045226130653 21;9 4.22110552763819 21;9 4.35175879396985 21;9 4.48241206030151 21;9 4.61306532663317 21;9 4.74371859296482 21;9 4.87437185929648 21;9 5.00502512562814 21;9 5.1356783919598 21;9 5.26633165829146 21;9 5.39698492462312 21;9 5.52763819095478 21;9 5.65829145728643 21;9 5.78894472361809 21;9 5.91959798994975 21;9 6.05025125628141 21;9 6.18090452261307 21;9 6.31155778894473 21;9 6.44221105527639 21;9 6.57286432160805 21;9 6.7035175879397 21;9 6.83417085427136 21;9 6.96482412060302 21;9 7.09547738693468 21;9 7.22613065326634 21;9 7.356783919598 21;9 7.48743718592966 21;9 7.61809045226131 21;9 7.74874371859297 21;9 7.87939698492463 21;9 8.01005025125629 21;9 8.14070351758795 21;9 8.27135678391961 21;9 8.40201005025126 21;9 8.53266331658292 21;9 8.66331658291458 21;9 8.79396984924624 21;9 8.92462311557789 21;9 9.05527638190955 21;9 9.18592964824121 21;9 9.31658291457287 21;9 9.44723618090453 21;9 9.57788944723618 21;9 9.70854271356784 21;9 9.8391959798995 21;9 9.96984924623116 21;9 10.1005025125628 21;9 10.2311557788945 21;9 10.3618090452261 21;9 10.4924623115578 21;9 10.6231155778894 21;9 10.7537688442211 21;9 10.8844221105528 21;9 11.0150753768844 21;9 11.1457286432161 21;9 11.2763819095477 21;9 11.4070351758794 21;9 11.537688442211 21;9 11.6683417085427 21;9 11.7989949748744 21;9 11.929648241206 21;9 12.0603015075377 21;9 12.1909547738693 21;9 12.321608040201 21;9 12.4522613065327 21;9 12.5829145728643 21;9 12.713567839196 21;9 12.8442211055276 21;9 12.9748743718593 21;9 13.1055276381909 21;9 13.2361809045226 21;9 13.3668341708543 21;9 13.4974874371859 21;9 13.6281407035176 21;9 13.7587939698492 21;9 13.8894472361809 21;9 14.0201005025125 21;9 14.1507537688442 21;9 14.2814070351759 21;9 14.4120603015075 21;9 14.5427135678392 21;9 14.6733668341708 21;9 14.8040201005025 21;9 14.9346733668342 21;9 15.0653266331658 21;9 15.1959798994975 21;9 15.3266331658291 21;9 15.4572864321608 21;9 15.5879396984924 21;9 15.7185929648241 21;9 15.8492462311558 21;9 15.9798994974874 21;9 16.1105527638191 21;9 16.2412060301507 21;9 16.3718592964824 21;9 16.5025125628141 21;9 16.6331658291457 21;9 16.7638190954774 21;9 16.894472361809 21;9 17.0251256281407 21;9 17.1557788944723 21;9 17.286432160804 21;9 17.4170854271357 21;9 17.5477386934673 21;9 17.678391959799 21;9 17.8090452261306 21;9 17.9396984924623 21;9 18.070351758794 21;9 18.2010050251256 21;9 18.3316582914573 21;9 18.4623115577889 21;9 18.5929648241206 21;9 18.7236180904523 21;9 18.8542713567839 21;9 18.9849246231156 21;9 19.1155778894472 21;9 19.2462311557789 21;9 19.3768844221106 21;9 19.5075376884422 21;9 19.6381909547739 21;9 19.7688442211055 21;9 19.8994974874372 21;9 20.0301507537689 21;9 20.1608040201005 21;9 20.2914572864322 21;9 20.4221105527638 21;9 20.5527638190955 21;9 20.6834170854272 21;9 20.8140703517588 21;9 20.9447236180905 21;9 21.0753768844221 21;9 21.2060301507538 21;9 21.3366834170855 21;9 21.4673366834171 21;9 21.5979899497488 21;9 21.7286432160804 21;9 21.8592964824121 21;9 21.9899497487438 21;9 22.1206030150754 21;9 22.2512562814071 21;9 22.3819095477387 21;9 22.5125628140704 21;9 22.643216080402 21;9 22.7738693467337 21;9 22.9045226130654 21;9 23.035175879397 21;9 23.1658291457287 21;9 23.2964824120603 21;9 23.427135678392 21;9 23.5577889447237 21;9 23.6884422110553 21;9 23.819095477387 21;9 23.9497487437186 21;9 24.0804020100503 21;9 24.211055276382 21;9 24.3417085427136 21;9 24.4723618090453 21;9 24.6030150753769 21;9 24.7336683417086 21;9 24.8643216080403 21;9 24.9949748743719 21;9 25.1256281407036 21;9 25.2562814070352 21;9 25.3869346733669 21;9 25.5175879396986 21;9 25.6482412060302 21;9 25.7788944723619 21;9 25.9095477386935 21;9 26.0402010050252 21;9 26.1708542713569 21;9 26.3015075376885 21;9 26.4321608040202 21;9 26.5628140703518 21;9 26.6934673366835 21;9 26.8241206030152 21;9 26.9547738693468 21;9 27.0854271356785 21;9 27.2160804020101 21;9 27.3467336683418 21;9 27.4773869346735 21;9 27.6080402010051 21;9 27.7386934673368 21;9 27.8693467336684 21;9 28.0000000000001 21];
mesh_tmp.source.num = (1:size([9 2 21;9 2.13065326633166 21;9 2.26130653266332 21;9 2.39195979899497 21;9 2.52261306532663 21;9 2.65326633165829 21;9 2.78391959798995 21;9 2.91457286432161 21;9 3.04522613065327 21;9 3.17587939698492 21;9 3.30653266331658 21;9 3.43718592964824 21;9 3.5678391959799 21;9 3.69849246231156 21;9 3.82914572864321 21;9 3.95979899497487 21;9 4.09045226130653 21;9 4.22110552763819 21;9 4.35175879396985 21;9 4.48241206030151 21;9 4.61306532663317 21;9 4.74371859296482 21;9 4.87437185929648 21;9 5.00502512562814 21;9 5.1356783919598 21;9 5.26633165829146 21;9 5.39698492462312 21;9 5.52763819095478 21;9 5.65829145728643 21;9 5.78894472361809 21;9 5.91959798994975 21;9 6.05025125628141 21;9 6.18090452261307 21;9 6.31155778894473 21;9 6.44221105527639 21;9 6.57286432160805 21;9 6.7035175879397 21;9 6.83417085427136 21;9 6.96482412060302 21;9 7.09547738693468 21;9 7.22613065326634 21;9 7.356783919598 21;9 7.48743718592966 21;9 7.61809045226131 21;9 7.74874371859297 21;9 7.87939698492463 21;9 8.01005025125629 21;9 8.14070351758795 21;9 8.27135678391961 21;9 8.40201005025126 21;9 8.53266331658292 21;9 8.66331658291458 21;9 8.79396984924624 21;9 8.92462311557789 21;9 9.05527638190955 21;9 9.18592964824121 21;9 9.31658291457287 21;9 9.44723618090453 21;9 9.57788944723618 21;9 9.70854271356784 21;9 9.8391959798995 21;9 9.96984924623116 21;9 10.1005025125628 21;9 10.2311557788945 21;9 10.3618090452261 21;9 10.4924623115578 21;9 10.6231155778894 21;9 10.7537688442211 21;9 10.8844221105528 21;9 11.0150753768844 21;9 11.1457286432161 21;9 11.2763819095477 21;9 11.4070351758794 21;9 11.537688442211 21;9 11.6683417085427 21;9 11.7989949748744 21;9 11.929648241206 21;9 12.0603015075377 21;9 12.1909547738693 21;9 12.321608040201 21;9 12.4522613065327 21;9 12.5829145728643 21;9 12.713567839196 21;9 12.8442211055276 21;9 12.9748743718593 21;9 13.1055276381909 21;9 13.2361809045226 21;9 13.3668341708543 21;9 13.4974874371859 21;9 13.6281407035176 21;9 13.7587939698492 21;9 13.8894472361809 21;9 14.0201005025125 21;9 14.1507537688442 21;9 14.2814070351759 21;9 14.4120603015075 21;9 14.5427135678392 21;9 14.6733668341708 21;9 14.8040201005025 21;9 14.9346733668342 21;9 15.0653266331658 21;9 15.1959798994975 21;9 15.3266331658291 21;9 15.4572864321608 21;9 15.5879396984924 21;9 15.7185929648241 21;9 15.8492462311558 21;9 15.9798994974874 21;9 16.1105527638191 21;9 16.2412060301507 21;9 16.3718592964824 21;9 16.5025125628141 21;9 16.6331658291457 21;9 16.7638190954774 21;9 16.894472361809 21;9 17.0251256281407 21;9 17.1557788944723 21;9 17.286432160804 21;9 17.4170854271357 21;9 17.5477386934673 21;9 17.678391959799 21;9 17.8090452261306 21;9 17.9396984924623 21;9 18.070351758794 21;9 18.2010050251256 21;9 18.3316582914573 21;9 18.4623115577889 21;9 18.5929648241206 21;9 18.7236180904523 21;9 18.8542713567839 21;9 18.9849246231156 21;9 19.1155778894472 21;9 19.2462311557789 21;9 19.3768844221106 21;9 19.5075376884422 21;9 19.6381909547739 21;9 19.7688442211055 21;9 19.8994974874372 21;9 20.0301507537689 21;9 20.1608040201005 21;9 20.2914572864322 21;9 20.4221105527638 21;9 20.5527638190955 21;9 20.6834170854272 21;9 20.8140703517588 21;9 20.9447236180905 21;9 21.0753768844221 21;9 21.2060301507538 21;9 21.3366834170855 21;9 21.4673366834171 21;9 21.5979899497488 21;9 21.7286432160804 21;9 21.8592964824121 21;9 21.9899497487438 21;9 22.1206030150754 21;9 22.2512562814071 21;9 22.3819095477387 21;9 22.5125628140704 21;9 22.643216080402 21;9 22.7738693467337 21;9 22.9045226130654 21;9 23.035175879397 21;9 23.1658291457287 21;9 23.2964824120603 21;9 23.427135678392 21;9 23.5577889447237 21;9 23.6884422110553 21;9 23.819095477387 21;9 23.9497487437186 21;9 24.0804020100503 21;9 24.211055276382 21;9 24.3417085427136 21;9 24.4723618090453 21;9 24.6030150753769 21;9 24.7336683417086 21;9 24.8643216080403 21;9 24.9949748743719 21;9 25.1256281407036 21;9 25.2562814070352 21;9 25.3869346733669 21;9 25.5175879396986 21;9 25.6482412060302 21;9 25.7788944723619 21;9 25.9095477386935 21;9 26.0402010050252 21;9 26.1708542713569 21;9 26.3015075376885 21;9 26.4321608040202 21;9 26.5628140703518 21;9 26.6934673366835 21;9 26.8241206030152 21;9 26.9547738693468 21;9 27.0854271356785 21;9 27.2160804020101 21;9 27.3467336683418 21;9 27.4773869346735 21;9 27.6080402010051 21;9 27.7386934673368 21;9 27.8693467336684 21;9 28.0000000000001 21],1))';
mesh_tmp.source.fwhm = zeros(size([9 2 21;9 2.13065326633166 21;9 2.26130653266332 21;9 2.39195979899497 21;9 2.52261306532663 21;9 2.65326633165829 21;9 2.78391959798995 21;9 2.91457286432161 21;9 3.04522613065327 21;9 3.17587939698492 21;9 3.30653266331658 21;9 3.43718592964824 21;9 3.5678391959799 21;9 3.69849246231156 21;9 3.82914572864321 21;9 3.95979899497487 21;9 4.09045226130653 21;9 4.22110552763819 21;9 4.35175879396985 21;9 4.48241206030151 21;9 4.61306532663317 21;9 4.74371859296482 21;9 4.87437185929648 21;9 5.00502512562814 21;9 5.1356783919598 21;9 5.26633165829146 21;9 5.39698492462312 21;9 5.52763819095478 21;9 5.65829145728643 21;9 5.78894472361809 21;9 5.91959798994975 21;9 6.05025125628141 21;9 6.18090452261307 21;9 6.31155778894473 21;9 6.44221105527639 21;9 6.57286432160805 21;9 6.7035175879397 21;9 6.83417085427136 21;9 6.96482412060302 21;9 7.09547738693468 21;9 7.22613065326634 21;9 7.356783919598 21;9 7.48743718592966 21;9 7.61809045226131 21;9 7.74874371859297 21;9 7.87939698492463 21;9 8.01005025125629 21;9 8.14070351758795 21;9 8.27135678391961 21;9 8.40201005025126 21;9 8.53266331658292 21;9 8.66331658291458 21;9 8.79396984924624 21;9 8.92462311557789 21;9 9.05527638190955 21;9 9.18592964824121 21;9 9.31658291457287 21;9 9.44723618090453 21;9 9.57788944723618 21;9 9.70854271356784 21;9 9.8391959798995 21;9 9.96984924623116 21;9 10.1005025125628 21;9 10.2311557788945 21;9 10.3618090452261 21;9 10.4924623115578 21;9 10.6231155778894 21;9 10.7537688442211 21;9 10.8844221105528 21;9 11.0150753768844 21;9 11.1457286432161 21;9 11.2763819095477 21;9 11.4070351758794 21;9 11.537688442211 21;9 11.6683417085427 21;9 11.7989949748744 21;9 11.929648241206 21;9 12.0603015075377 21;9 12.1909547738693 21;9 12.321608040201 21;9 12.4522613065327 21;9 12.5829145728643 21;9 12.713567839196 21;9 12.8442211055276 21;9 12.9748743718593 21;9 13.1055276381909 21;9 13.2361809045226 21;9 13.3668341708543 21;9 13.4974874371859 21;9 13.6281407035176 21;9 13.7587939698492 21;9 13.8894472361809 21;9 14.0201005025125 21;9 14.1507537688442 21;9 14.2814070351759 21;9 14.4120603015075 21;9 14.5427135678392 21;9 14.6733668341708 21;9 14.8040201005025 21;9 14.9346733668342 21;9 15.0653266331658 21;9 15.1959798994975 21;9 15.3266331658291 21;9 15.4572864321608 21;9 15.5879396984924 21;9 15.7185929648241 21;9 15.8492462311558 21;9 15.9798994974874 21;9 16.1105527638191 21;9 16.2412060301507 21;9 16.3718592964824 21;9 16.5025125628141 21;9 16.6331658291457 21;9 16.7638190954774 21;9 16.894472361809 21;9 17.0251256281407 21;9 17.1557788944723 21;9 17.286432160804 21;9 17.4170854271357 21;9 17.5477386934673 21;9 17.678391959799 21;9 17.8090452261306 21;9 17.9396984924623 21;9 18.070351758794 21;9 18.2010050251256 21;9 18.3316582914573 21;9 18.4623115577889 21;9 18.5929648241206 21;9 18.7236180904523 21;9 18.8542713567839 21;9 18.9849246231156 21;9 19.1155778894472 21;9 19.2462311557789 21;9 19.3768844221106 21;9 19.5075376884422 21;9 19.6381909547739 21;9 19.7688442211055 21;9 19.8994974874372 21;9 20.0301507537689 21;9 20.1608040201005 21;9 20.2914572864322 21;9 20.4221105527638 21;9 20.5527638190955 21;9 20.6834170854272 21;9 20.8140703517588 21;9 20.9447236180905 21;9 21.0753768844221 21;9 21.2060301507538 21;9 21.3366834170855 21;9 21.4673366834171 21;9 21.5979899497488 21;9 21.7286432160804 21;9 21.8592964824121 21;9 21.9899497487438 21;9 22.1206030150754 21;9 22.2512562814071 21;9 22.3819095477387 21;9 22.5125628140704 21;9 22.643216080402 21;9 22.7738693467337 21;9 22.9045226130654 21;9 23.035175879397 21;9 23.1658291457287 21;9 23.2964824120603 21;9 23.427135678392 21;9 23.5577889447237 21;9 23.6884422110553 21;9 23.819095477387 21;9 23.9497487437186 21;9 24.0804020100503 21;9 24.211055276382 21;9 24.3417085427136 21;9 24.4723618090453 21;9 24.6030150753769 21;9 24.7336683417086 21;9 24.8643216080403 21;9 24.9949748743719 21;9 25.1256281407036 21;9 25.2562814070352 21;9 25.3869346733669 21;9 25.5175879396986 21;9 25.6482412060302 21;9 25.7788944723619 21;9 25.9095477386935 21;9 26.0402010050252 21;9 26.1708542713569 21;9 26.3015075376885 21;9 26.4321608040202 21;9 26.5628140703518 21;9 26.6934673366835 21;9 26.8241206030152 21;9 26.9547738693468 21;9 27.0854271356785 21;9 27.2160804020101 21;9 27.3467336683418 21;9 27.4773869346735 21;9 27.6080402010051 21;9 27.7386934673368 21;9 27.8693467336684 21;9 28.0000000000001 21],1),1);
mesh_tmp.source.fixed =0;
mesh_tmp.source.distributed =1;
mesh_tmp.meas.coord =[9 15 15];
mesh_tmp.meas.num = (1:size([9 15 15],1))';
mesh_tmp.meas.fixed =0;
mesh_tmp = minband_opt(mesh_tmp);
save_mesh(mesh_tmp,'/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_new_mimicCC_0.05_flip_nirfast_mesh');
clear mesh_tmp
mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_new_mimicCC_0.05_flip_nirfast_mesh');
set_chromophores('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_new_mimicCC_0.05_flip_nirfast_mesh',{'HbO';'deoxyHb';'Water';},[700 710 720 730 740 750 760 770 780 790 800 810 820 830 840 850 860 870 880 890 900]);
mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_new_mimicCC_0.05_flip_nirfast_mesh');
