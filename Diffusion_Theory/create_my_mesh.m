gis_args.medfilter=1;
[mask param] = GetImageStack('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_mimicCC_0.2_flip.mha',gis_args);

param.facet_angle = (1);
param.facet_distance = (0.1);
param.facet_size = (0.8);

param.medfilter = 0;
param.pad = 0;
param.cell_size = (0.8);
param.cell_radius_edge = (3.0);
param.special_subdomain_label = (0);
param.special_subdomain_size  = (0);

sx=(0.2);
sy=(0.2);
sz=(0.2);

param.PixelDimensions(1) = sx;
param.PixelDimensions(2) = sy;
param.PixelDimensions(3) = sz;
param.PixelSpacing(1) = sx;
param.PixelSpacing(2) = sy;
param.SliceThickness  = sz;

outfn = '/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_mimicCC_0.2_flip.ele';
param.tmppath = fileparts(outfn);
if isempty(param.tmppath), param.tmppath = getuserdir(); end
param.delmedit = 0;

[e p] = RunCGALMeshGenerator(mask,param);
if size(e,2) > 4, mat = e(:,5); else, mat = ones(size(e,1),1); end

q1 = simpqual(p, e, 'Min_Sin_Dihedral');
genmesh.ele = e;
genmesh.node = p;
genmesh.ele(:,5) = mat; genmesh.nnpe = 4; genmesh.dim = 3;
solidmesh2nirfast(genmesh,'/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_mimicCC_0.2_flip_nirfast_mesh','spec');
fprintf('done.\n');

mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_mimicCC_0.2_flip_nirfast_mesh');
clear e f1 f2 genmesh info mask mat e p sx sy sz cr1 cr2 genmesh outfn param
clear save_fn
%--------------------%

mesh_tmp = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_mimicCC_0.2_flip_nirfast_mesh');
mesh_tmp.link =[ 1 1 1; 2 1 1; 3 1 1; 4 1 1; 5 1 1; 6 1 1; 7 1 1; 8 1 1; 9 1 1; 10 1 1; 11 1 1; 12 1 1; 13 1 1; 14 1 1; 15 1 1; 16 1 1; 17 1 1; 18 1 1; 19 1 1; 20 1 1; 21 1 1; 22 1 1; 23 1 1; 24 1 1; 25 1 1; 26 1 1; 27 1 1; 28 1 1; 29 1 1; 30 1 1; 31 1 1; 32 1 1; 33 1 1; 34 1 1; 35 1 1; 36 1 1; 37 1 1; 38 1 1; 39 1 1; 40 1 1; 41 1 1; 42 1 1; 43 1 1; 44 1 1; 45 1 1; 46 1 1; 47 1 1; 48 1 1; 49 1 1; 50 1 1; 51 1 1; 52 1 1; 53 1 1; 54 1 1; 55 1 1; 56 1 1; 57 1 1; 58 1 1; 59 1 1; 60 1 1; 61 1 1; 62 1 1; 63 1 1; 64 1 1; 65 1 1; 66 1 1; 67 1 1; 68 1 1; 69 1 1; 70 1 1; 71 1 1; 72 1 1; 73 1 1; 74 1 1; 75 1 1; 76 1 1; 77 1 1; 78 1 1; 79 1 1; 80 1 1; 81 1 1; 82 1 1; 83 1 1; 84 1 1; 85 1 1; 86 1 1; 87 1 1; 88 1 1; 89 1 1; 90 1 1; 91 1 1; 92 1 1; 93 1 1; 94 1 1; 95 1 1; 96 1 1; 97 1 1; 98 1 1; 99 1 1; 100 1 1;];
mesh_tmp.source.coord =[9 5 21;9 5.2020202020202 21;9 5.4040404040404 21;9 5.60606060606061 21;9 5.80808080808081 21;9 6.01010101010101 21;9 6.21212121212121 21;9 6.41414141414142 21;9 6.61616161616162 21;9 6.81818181818182 21;9 7.02020202020202 21;9 7.22222222222223 21;9 7.42424242424243 21;9 7.62626262626263 21;9 7.82828282828283 21;9 8.03030303030304 21;9 8.23232323232324 21;9 8.43434343434344 21;9 8.63636363636364 21;9 8.83838383838385 21;9 9.04040404040405 21;9 9.24242424242425 21;9 9.44444444444445 21;9 9.64646464646466 21;9 9.84848484848486 21;9 10.0505050505051 21;9 10.2525252525253 21;9 10.4545454545455 21;9 10.6565656565657 21;9 10.8585858585859 21;9 11.0606060606061 21;9 11.2626262626263 21;9 11.4646464646465 21;9 11.6666666666667 21;9 11.8686868686869 21;9 12.0707070707071 21;9 12.2727272727273 21;9 12.4747474747475 21;9 12.6767676767677 21;9 12.8787878787879 21;9 13.0808080808081 21;9 13.2828282828283 21;9 13.4848484848485 21;9 13.6868686868687 21;9 13.8888888888889 21;9 14.0909090909091 21;9 14.2929292929293 21;9 14.4949494949495 21;9 14.6969696969697 21;9 14.8989898989899 21;9 15.1010101010101 21;9 15.3030303030303 21;9 15.5050505050505 21;9 15.7070707070707 21;9 15.9090909090909 21;9 16.1111111111111 21;9 16.3131313131313 21;9 16.5151515151515 21;9 16.7171717171717 21;9 16.9191919191919 21;9 17.1212121212121 21;9 17.3232323232323 21;9 17.5252525252525 21;9 17.7272727272727 21;9 17.9292929292929 21;9 18.1313131313131 21;9 18.3333333333333 21;9 18.5353535353535 21;9 18.7373737373737 21;9 18.9393939393939 21;9 19.1414141414141 21;9 19.3434343434343 21;9 19.5454545454545 21;9 19.7474747474747 21;9 19.9494949494949 21;9 20.1515151515151 21;9 20.3535353535353 21;9 20.5555555555555 21;9 20.7575757575757 21;9 20.9595959595959 21;9 21.1616161616161 21;9 21.3636363636363 21;9 21.5656565656565 21;9 21.7676767676768 21;9 21.969696969697 21;9 22.1717171717172 21;9 22.3737373737374 21;9 22.5757575757576 21;9 22.7777777777778 21;9 22.979797979798 21;9 23.1818181818182 21;9 23.3838383838384 21;9 23.5858585858586 21;9 23.7878787878788 21;9 23.989898989899 21;9 24.1919191919192 21;9 24.3939393939394 21;9 24.5959595959596 21;9 24.7979797979798 21;9 25 21];
mesh_tmp.source.num = (1:size([9 5 21;9 5.2020202020202 21;9 5.4040404040404 21;9 5.60606060606061 21;9 5.80808080808081 21;9 6.01010101010101 21;9 6.21212121212121 21;9 6.41414141414142 21;9 6.61616161616162 21;9 6.81818181818182 21;9 7.02020202020202 21;9 7.22222222222223 21;9 7.42424242424243 21;9 7.62626262626263 21;9 7.82828282828283 21;9 8.03030303030304 21;9 8.23232323232324 21;9 8.43434343434344 21;9 8.63636363636364 21;9 8.83838383838385 21;9 9.04040404040405 21;9 9.24242424242425 21;9 9.44444444444445 21;9 9.64646464646466 21;9 9.84848484848486 21;9 10.0505050505051 21;9 10.2525252525253 21;9 10.4545454545455 21;9 10.6565656565657 21;9 10.8585858585859 21;9 11.0606060606061 21;9 11.2626262626263 21;9 11.4646464646465 21;9 11.6666666666667 21;9 11.8686868686869 21;9 12.0707070707071 21;9 12.2727272727273 21;9 12.4747474747475 21;9 12.6767676767677 21;9 12.8787878787879 21;9 13.0808080808081 21;9 13.2828282828283 21;9 13.4848484848485 21;9 13.6868686868687 21;9 13.8888888888889 21;9 14.0909090909091 21;9 14.2929292929293 21;9 14.4949494949495 21;9 14.6969696969697 21;9 14.8989898989899 21;9 15.1010101010101 21;9 15.3030303030303 21;9 15.5050505050505 21;9 15.7070707070707 21;9 15.9090909090909 21;9 16.1111111111111 21;9 16.3131313131313 21;9 16.5151515151515 21;9 16.7171717171717 21;9 16.9191919191919 21;9 17.1212121212121 21;9 17.3232323232323 21;9 17.5252525252525 21;9 17.7272727272727 21;9 17.9292929292929 21;9 18.1313131313131 21;9 18.3333333333333 21;9 18.5353535353535 21;9 18.7373737373737 21;9 18.9393939393939 21;9 19.1414141414141 21;9 19.3434343434343 21;9 19.5454545454545 21;9 19.7474747474747 21;9 19.9494949494949 21;9 20.1515151515151 21;9 20.3535353535353 21;9 20.5555555555555 21;9 20.7575757575757 21;9 20.9595959595959 21;9 21.1616161616161 21;9 21.3636363636363 21;9 21.5656565656565 21;9 21.7676767676768 21;9 21.969696969697 21;9 22.1717171717172 21;9 22.3737373737374 21;9 22.5757575757576 21;9 22.7777777777778 21;9 22.979797979798 21;9 23.1818181818182 21;9 23.3838383838384 21;9 23.5858585858586 21;9 23.7878787878788 21;9 23.989898989899 21;9 24.1919191919192 21;9 24.3939393939394 21;9 24.5959595959596 21;9 24.7979797979798 21;9 25 21],1))';
mesh_tmp.source.fwhm = zeros(size([9 5 21;9 5.2020202020202 21;9 5.4040404040404 21;9 5.60606060606061 21;9 5.80808080808081 21;9 6.01010101010101 21;9 6.21212121212121 21;9 6.41414141414142 21;9 6.61616161616162 21;9 6.81818181818182 21;9 7.02020202020202 21;9 7.22222222222223 21;9 7.42424242424243 21;9 7.62626262626263 21;9 7.82828282828283 21;9 8.03030303030304 21;9 8.23232323232324 21;9 8.43434343434344 21;9 8.63636363636364 21;9 8.83838383838385 21;9 9.04040404040405 21;9 9.24242424242425 21;9 9.44444444444445 21;9 9.64646464646466 21;9 9.84848484848486 21;9 10.0505050505051 21;9 10.2525252525253 21;9 10.4545454545455 21;9 10.6565656565657 21;9 10.8585858585859 21;9 11.0606060606061 21;9 11.2626262626263 21;9 11.4646464646465 21;9 11.6666666666667 21;9 11.8686868686869 21;9 12.0707070707071 21;9 12.2727272727273 21;9 12.4747474747475 21;9 12.6767676767677 21;9 12.8787878787879 21;9 13.0808080808081 21;9 13.2828282828283 21;9 13.4848484848485 21;9 13.6868686868687 21;9 13.8888888888889 21;9 14.0909090909091 21;9 14.2929292929293 21;9 14.4949494949495 21;9 14.6969696969697 21;9 14.8989898989899 21;9 15.1010101010101 21;9 15.3030303030303 21;9 15.5050505050505 21;9 15.7070707070707 21;9 15.9090909090909 21;9 16.1111111111111 21;9 16.3131313131313 21;9 16.5151515151515 21;9 16.7171717171717 21;9 16.9191919191919 21;9 17.1212121212121 21;9 17.3232323232323 21;9 17.5252525252525 21;9 17.7272727272727 21;9 17.9292929292929 21;9 18.1313131313131 21;9 18.3333333333333 21;9 18.5353535353535 21;9 18.7373737373737 21;9 18.9393939393939 21;9 19.1414141414141 21;9 19.3434343434343 21;9 19.5454545454545 21;9 19.7474747474747 21;9 19.9494949494949 21;9 20.1515151515151 21;9 20.3535353535353 21;9 20.5555555555555 21;9 20.7575757575757 21;9 20.9595959595959 21;9 21.1616161616161 21;9 21.3636363636363 21;9 21.5656565656565 21;9 21.7676767676768 21;9 21.969696969697 21;9 22.1717171717172 21;9 22.3737373737374 21;9 22.5757575757576 21;9 22.7777777777778 21;9 22.979797979798 21;9 23.1818181818182 21;9 23.3838383838384 21;9 23.5858585858586 21;9 23.7878787878788 21;9 23.989898989899 21;9 24.1919191919192 21;9 24.3939393939394 21;9 24.5959595959596 21;9 24.7979797979798 21;9 25 21],1),1);
mesh_tmp.source.fixed =0;
mesh_tmp.source.distributed =1;
mesh_tmp.meas.coord =[9 15 15];
mesh_tmp.meas.num = (1:size([9 15 15],1))';
mesh_tmp.meas.fixed =0;
mesh_tmp = minband_opt(mesh_tmp);
save_mesh(mesh_tmp,'/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_mimicCC_0.2_flip_nirfast_mesh');
clear mesh_tmp
mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_mimicCC_0.2_flip_nirfast_mesh');
set_chromophores('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_mimicCC_0.2_flip_nirfast_mesh',{'HbO';'deoxyHb';'Water';},[700 710 720 730 740 750 760 770 780 790 800 810 820 830 840 850 860 870 880 890 900]);
mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_mimicCC_0.2_flip_nirfast_mesh');
