gis_args.medfilter=1;
[mask param] = GetImageStack('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_deep_mimicCC_0.2_flip.mha',gis_args);

param.facet_angle = (25.0);
param.facet_distance = (0.8);
param.facet_size = (0.8);

param.medfilter = 0;
param.pad = 0;
param.cell_size = (0.8);
param.cell_radius_edge = (1);
param.special_subdomain_label = (0);
param.special_subdomain_size  = (0);

sx=(0.2);
sy=(0.2);
sz=(0.2);

param.PixelDimensions(1) = sx;
param.PixelDimensions(2) = sy;
param.PixelDimensions(3) = sz;
param.PixelSpacing(1) = sx;
param.PixelSpacing(2) = sy;
param.SliceThickness  = sz;

outfn = '/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_deep_mimicCC_0.2_flip.ele';
param.tmppath = fileparts(outfn);
if isempty(param.tmppath), param.tmppath = getuserdir(); end
param.delmedit = 0;

[e p] = RunCGALMeshGenerator(mask,param);
if size(e,2) > 4, mat = e(:,5); else, mat = ones(size(e,1),1); end

q1 = simpqual(p, e, 'Min_Sin_Dihedral');
genmesh.ele = e;
genmesh.node = p;
genmesh.ele(:,5) = mat; genmesh.nnpe = 4; genmesh.dim = 3;
solidmesh2nirfast(genmesh,'/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_deep_mimicCC_0.2_flip_nirfast_mesh','spec');
fprintf('done.\n');

mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_deep_mimicCC_0.2_flip_nirfast_mesh');
clear e f1 f2 genmesh info mask mat e p sx sy sz cr1 cr2 genmesh outfn param
clear save_fn
%--------------------%

mesh_tmp = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_deep_mimicCC_0.2_flip_nirfast_mesh');
mesh_tmp.link =[ 1 1 1; 2 1 1; 3 1 1; 4 1 1; 5 1 1; 6 1 1; 7 1 1; 8 1 1; 9 1 1; 10 1 1; 11 1 1; 12 1 1; 13 1 1; 14 1 1; 15 1 1; 16 1 1; 17 1 1; 18 1 1; 19 1 1; 20 1 1; 21 1 1; 22 1 1; 23 1 1; 24 1 1; 25 1 1; 26 1 1; 27 1 1; 28 1 1; 29 1 1; 30 1 1; 31 1 1; 32 1 1; 33 1 1; 34 1 1; 35 1 1; 36 1 1; 37 1 1; 38 1 1; 39 1 1; 40 1 1; 41 1 1; 42 1 1; 43 1 1; 44 1 1; 45 1 1; 46 1 1; 47 1 1; 48 1 1; 49 1 1; 50 1 1; 51 1 1; 52 1 1; 53 1 1; 54 1 1; 55 1 1; 56 1 1; 57 1 1; 58 1 1; 59 1 1; 60 1 1; 61 1 1; 62 1 1; 63 1 1; 64 1 1; 65 1 1; 66 1 1; 67 1 1; 68 1 1; 69 1 1; 70 1 1; 71 1 1; 72 1 1; 73 1 1; 74 1 1; 75 1 1; 76 1 1; 77 1 1; 78 1 1; 79 1 1; 80 1 1; 81 1 1; 82 1 1; 83 1 1; 84 1 1; 85 1 1; 86 1 1; 87 1 1; 88 1 1; 89 1 1; 90 1 1; 91 1 1; 92 1 1; 93 1 1; 94 1 1; 95 1 1; 96 1 1; 97 1 1; 98 1 1; 99 1 1; 100 1 1;];
mesh_tmp.source.coord =[6 2 26;6 2.26262626262626 26;6 2.52525252525253 26;6 2.78787878787879 26;6 3.05050505050505 26;6 3.31313131313131 26;6 3.57575757575758 26;6 3.83838383838384 26;6 4.1010101010101 26;6 4.36363636363636 26;6 4.62626262626263 26;6 4.88888888888889 26;6 5.15151515151515 26;6 5.41414141414142 26;6 5.67676767676768 26;6 5.93939393939394 26;6 6.2020202020202 26;6 6.46464646464647 26;6 6.72727272727273 26;6 6.98989898989899 26;6 7.25252525252526 26;6 7.51515151515152 26;6 7.77777777777778 26;6 8.04040404040405 26;6 8.30303030303031 26;6 8.56565656565657 26;6 8.82828282828283 26;6 9.0909090909091 26;6 9.35353535353536 26;6 9.61616161616162 26;6 9.87878787878789 26;6 10.1414141414141 26;6 10.4040404040404 26;6 10.6666666666667 26;6 10.9292929292929 26;6 11.1919191919192 26;6 11.4545454545455 26;6 11.7171717171717 26;6 11.979797979798 26;6 12.2424242424243 26;6 12.5050505050505 26;6 12.7676767676768 26;6 13.030303030303 26;6 13.2929292929293 26;6 13.5555555555556 26;6 13.8181818181818 26;6 14.0808080808081 26;6 14.3434343434344 26;6 14.6060606060606 26;6 14.8686868686869 26;6 15.1313131313131 26;6 15.3939393939394 26;6 15.6565656565657 26;6 15.9191919191919 26;6 16.1818181818182 26;6 16.4444444444445 26;6 16.7070707070707 26;6 16.969696969697 26;6 17.2323232323232 26;6 17.4949494949495 26;6 17.7575757575758 26;6 18.020202020202 26;6 18.2828282828283 26;6 18.5454545454546 26;6 18.8080808080808 26;6 19.0707070707071 26;6 19.3333333333334 26;6 19.5959595959596 26;6 19.8585858585859 26;6 20.1212121212121 26;6 20.3838383838384 26;6 20.6464646464647 26;6 20.9090909090909 26;6 21.1717171717172 26;6 21.4343434343435 26;6 21.6969696969697 26;6 21.959595959596 26;6 22.2222222222222 26;6 22.4848484848485 26;6 22.7474747474748 26;6 23.010101010101 26;6 23.2727272727273 26;6 23.5353535353536 26;6 23.7979797979798 26;6 24.0606060606061 26;6 24.3232323232324 26;6 24.5858585858586 26;6 24.8484848484849 26;6 25.1111111111111 26;6 25.3737373737374 26;6 25.6363636363637 26;6 25.8989898989899 26;6 26.1616161616162 26;6 26.4242424242425 26;6 26.6868686868687 26;6 26.949494949495 26;6 27.2121212121212 26;6 27.4747474747475 26;6 27.7373737373738 26;6 28 26];
mesh_tmp.source.num = (1:size([6 2 26;6 2.26262626262626 26;6 2.52525252525253 26;6 2.78787878787879 26;6 3.05050505050505 26;6 3.31313131313131 26;6 3.57575757575758 26;6 3.83838383838384 26;6 4.1010101010101 26;6 4.36363636363636 26;6 4.62626262626263 26;6 4.88888888888889 26;6 5.15151515151515 26;6 5.41414141414142 26;6 5.67676767676768 26;6 5.93939393939394 26;6 6.2020202020202 26;6 6.46464646464647 26;6 6.72727272727273 26;6 6.98989898989899 26;6 7.25252525252526 26;6 7.51515151515152 26;6 7.77777777777778 26;6 8.04040404040405 26;6 8.30303030303031 26;6 8.56565656565657 26;6 8.82828282828283 26;6 9.0909090909091 26;6 9.35353535353536 26;6 9.61616161616162 26;6 9.87878787878789 26;6 10.1414141414141 26;6 10.4040404040404 26;6 10.6666666666667 26;6 10.9292929292929 26;6 11.1919191919192 26;6 11.4545454545455 26;6 11.7171717171717 26;6 11.979797979798 26;6 12.2424242424243 26;6 12.5050505050505 26;6 12.7676767676768 26;6 13.030303030303 26;6 13.2929292929293 26;6 13.5555555555556 26;6 13.8181818181818 26;6 14.0808080808081 26;6 14.3434343434344 26;6 14.6060606060606 26;6 14.8686868686869 26;6 15.1313131313131 26;6 15.3939393939394 26;6 15.6565656565657 26;6 15.9191919191919 26;6 16.1818181818182 26;6 16.4444444444445 26;6 16.7070707070707 26;6 16.969696969697 26;6 17.2323232323232 26;6 17.4949494949495 26;6 17.7575757575758 26;6 18.020202020202 26;6 18.2828282828283 26;6 18.5454545454546 26;6 18.8080808080808 26;6 19.0707070707071 26;6 19.3333333333334 26;6 19.5959595959596 26;6 19.8585858585859 26;6 20.1212121212121 26;6 20.3838383838384 26;6 20.6464646464647 26;6 20.9090909090909 26;6 21.1717171717172 26;6 21.4343434343435 26;6 21.6969696969697 26;6 21.959595959596 26;6 22.2222222222222 26;6 22.4848484848485 26;6 22.7474747474748 26;6 23.010101010101 26;6 23.2727272727273 26;6 23.5353535353536 26;6 23.7979797979798 26;6 24.0606060606061 26;6 24.3232323232324 26;6 24.5858585858586 26;6 24.8484848484849 26;6 25.1111111111111 26;6 25.3737373737374 26;6 25.6363636363637 26;6 25.8989898989899 26;6 26.1616161616162 26;6 26.4242424242425 26;6 26.6868686868687 26;6 26.949494949495 26;6 27.2121212121212 26;6 27.4747474747475 26;6 27.7373737373738 26;6 28 26],1))';
mesh_tmp.source.fwhm = zeros(size([6 2 26;6 2.26262626262626 26;6 2.52525252525253 26;6 2.78787878787879 26;6 3.05050505050505 26;6 3.31313131313131 26;6 3.57575757575758 26;6 3.83838383838384 26;6 4.1010101010101 26;6 4.36363636363636 26;6 4.62626262626263 26;6 4.88888888888889 26;6 5.15151515151515 26;6 5.41414141414142 26;6 5.67676767676768 26;6 5.93939393939394 26;6 6.2020202020202 26;6 6.46464646464647 26;6 6.72727272727273 26;6 6.98989898989899 26;6 7.25252525252526 26;6 7.51515151515152 26;6 7.77777777777778 26;6 8.04040404040405 26;6 8.30303030303031 26;6 8.56565656565657 26;6 8.82828282828283 26;6 9.0909090909091 26;6 9.35353535353536 26;6 9.61616161616162 26;6 9.87878787878789 26;6 10.1414141414141 26;6 10.4040404040404 26;6 10.6666666666667 26;6 10.9292929292929 26;6 11.1919191919192 26;6 11.4545454545455 26;6 11.7171717171717 26;6 11.979797979798 26;6 12.2424242424243 26;6 12.5050505050505 26;6 12.7676767676768 26;6 13.030303030303 26;6 13.2929292929293 26;6 13.5555555555556 26;6 13.8181818181818 26;6 14.0808080808081 26;6 14.3434343434344 26;6 14.6060606060606 26;6 14.8686868686869 26;6 15.1313131313131 26;6 15.3939393939394 26;6 15.6565656565657 26;6 15.9191919191919 26;6 16.1818181818182 26;6 16.4444444444445 26;6 16.7070707070707 26;6 16.969696969697 26;6 17.2323232323232 26;6 17.4949494949495 26;6 17.7575757575758 26;6 18.020202020202 26;6 18.2828282828283 26;6 18.5454545454546 26;6 18.8080808080808 26;6 19.0707070707071 26;6 19.3333333333334 26;6 19.5959595959596 26;6 19.8585858585859 26;6 20.1212121212121 26;6 20.3838383838384 26;6 20.6464646464647 26;6 20.9090909090909 26;6 21.1717171717172 26;6 21.4343434343435 26;6 21.6969696969697 26;6 21.959595959596 26;6 22.2222222222222 26;6 22.4848484848485 26;6 22.7474747474748 26;6 23.010101010101 26;6 23.2727272727273 26;6 23.5353535353536 26;6 23.7979797979798 26;6 24.0606060606061 26;6 24.3232323232324 26;6 24.5858585858586 26;6 24.8484848484849 26;6 25.1111111111111 26;6 25.3737373737374 26;6 25.6363636363637 26;6 25.8989898989899 26;6 26.1616161616162 26;6 26.4242424242425 26;6 26.6868686868687 26;6 26.949494949495 26;6 27.2121212121212 26;6 27.4747474747475 26;6 27.7373737373738 26;6 28 26],1),1);
mesh_tmp.source.fixed =0;
mesh_tmp.source.distributed =1;
mesh_tmp.meas.coord =[6 15 13];
mesh_tmp.meas.num = (1:size([6 15 13],1))';
mesh_tmp.meas.fixed =0;
mesh_tmp = minband_opt(mesh_tmp);
save_mesh(mesh_tmp,'/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_deep_mimicCC_0.2_flip_nirfast_mesh');
clear mesh_tmp
mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_deep_mimicCC_0.2_flip_nirfast_mesh');
set_chromophores('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_deep_mimicCC_0.2_flip_nirfast_mesh',{'HbO';'deoxyHb';'Water';},[700 710 720 730 740 750 760 770 780 790 800 810 820 830 840 850 860 870 880 890 900]);
mesh = load_mesh('/home/zz111/Spectral_unmixing/cc_diffusion_theory/digital_vessel_deep_mimicCC_0.2_flip_nirfast_mesh');
